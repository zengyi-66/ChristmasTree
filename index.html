<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>üéÑ ÊåáÂ∞ñÈ≠îÊ≥ï V78</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: monospace; touch-action: none; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        
        #start-btn {
            padding: 15px 40px; font-size: 20px;
            color: #000; background: #00ff00;
            border: none; border-radius: 50px;
            cursor: pointer; margin-bottom: 20px;
            font-weight: bold; box-shadow: 0 0 20px rgba(0,255,0,0.4);
            opacity: 0.5; pointer-events: none; 
            transition: all 0.3s;
        }
        #start-btn.ready { opacity: 1; pointer-events: auto; }
        
        #console-log {
            width: 90%; height: 200px;
            background: #000; border: 1px solid #333;
            color: #ccc; font-size: 11px;
            padding: 10px; overflow-y: auto;
            border-radius: 4px; text-align: left;
        }
        .log-line { border-bottom: 1px solid #222; padding: 2px 0; }
        .err { color: #ff3333; background: rgba(50,0,0,0.5); }
        .ok { color: #33ff33; }
        .warn { color: #ffff33; }

        #webcam-video { display: none; }
        #ui-layer { position: absolute; bottom: 20px; left: 20px; z-index: 10; display: flex; gap: 15px; }
        .icon-btn { 
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255,255,255,0.2); 
            color: gold; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/+esm"
            }
        }
    </script>
</head>
<body>

    <div id="start-screen">
        <h2 style="color:#fff; margin-bottom:10px;">ÊåáÂ∞ñÈ≠îÊ≥ï V78</h2>
        <button id="start-btn">‚è≥ Ê≠£Âú®‰∏ãËΩΩÁªÑ‰ª∂...</button>
        <div id="console-log">
            <div class="log-line">ÂàùÂßãÂåñÁ≥ªÁªü...</div>
        </div>
    </div>

    <div id="canvas-container"></div>
    <video id="webcam-video" playsinline muted autoplay></video>

    <div id="ui-layer">
        <div class="icon-btn" id="btn-tree">üå≤</div>
        <div class="icon-btn" id="btn-scatter">‚ú®</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // --- ÂÜÖÈÉ®Êó•ÂøóÁ≥ªÁªü ---
        function sysLog(msg, type='info') {
            const box = document.getElementById('console-log');
            if(!box) return;
            const line = document.createElement('div');
            line.className = 'log-line ' + type;
            line.innerText = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}`;
            box.appendChild(line);
            box.scrollTop = box.scrollHeight;
        }

        // ËÑöÊú¨ËÉΩËøêË°åÂà∞ËøôÈáåÔºåËØ¥Êòé import ÊàêÂäü‰∫ÜÔºÅ
        sysLog("‚úÖ Ê†∏ÂøÉÂ∫ìÂä†ËΩΩÊàêÂäüÔºÅ", "ok");
        const startBtn = document.getElementById('start-btn');
        startBtn.innerText = "üöÄ ÁÇπÂáªÂêØÂä®";
        startBtn.classList.add('ready');

        // === Ê†∏ÂøÉÈÖçÁΩÆ ===
        // Ê£ÄÊµãÊâãÊú∫Á´Ø
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const CONFIG = {
            count: isMobile ? 6000 : 25000, 
            colors: { gold: 0xffd966, green: 0x03180a, red: 0x990000 },
            exp: { tree: 2.0, scatter: 1.2 }
        };

        let scene, camera, renderer, composer;
        let particleSystem, goldMat;
        let handLandmarker, videoElement;
        let STATE = { mode: 'TREE', handX: 0, handY: 0 };

        // === ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂ ===
        startBtn.onclick = async () => {
            startBtn.style.display = 'none';
            sysLog("Áî®Êà∑ÁÇπÂáªÂêØÂä®...");

            try {
                sysLog("ÂàùÂßãÂåñ 3D Âú∫ÊôØ...");
                initThree();
                createParticles();
                sysLog("3D Ê∏≤ÊüìÂô®Â∞±Áª™", "ok");

                sysLog("Ê≠£Âú®Âä†ËΩΩ AI Ê®°Âûã (hand_landmarker.task)...");
                sysLog("ÊèêÁ§∫: ÂøÖÈ°ªÁ°Æ‰øù .task Êñá‰ª∂Â∑≤‰∏ä‰º†GitHub!", 'warn');
                
                // ËßÜËßâÂºïÊìé
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.8/wasm");
                
                // Ê®°Âûã (Âä†ËΩΩÊú¨Âú∞Êñá‰ª∂)
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "./hand_landmarker.task", 
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numHands: 1
                });
                sysLog("AI Ê®°ÂûãÂä†ËΩΩÊàêÂäü!", "ok");

                // ÊëÑÂÉèÂ§¥
                sysLog("ËØ∑Ê±ÇÊëÑÂÉèÂ§¥ÊùÉÈôê...");
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: 320, height: 240 } 
                });
                
                videoElement = document.getElementById('webcam-video');
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    sysLog("ÊëÑÂÉèÂ§¥ÁîªÈù¢Â∑≤Ëé∑Âèñ", "ok");
                    enterScene();
                    predictWebcam();
                };

            } catch (e) {
                sysLog("‚ùå ÂêØÂä®ÈòªÊñ≠: " + e.message, "err");
                if(e.message.includes("404") || e.message.includes("fetch")) {
                    sysLog("üëâ ËØ∑Ê£ÄÊü•: hand_landmarker.task Êñá‰ª∂ÂêçÊòØÂê¶Ê≠£Á°ÆÔºü", "warn");
                }
                // Âº∫Âà∂ËøõÂÖ•ÊºîÁ§∫Ê®°Âºè
                setTimeout(enterScene, 3000);
            }
        };

        // ÁªëÂÆöUIÊåâÈíÆ
        document.getElementById('btn-tree').onclick = () => STATE.mode = 'TREE';
        document.getElementById('btn-scatter').onclick = () => STATE.mode = 'SCATTER';

        function enterScene() {
            document.getElementById('start-screen').style.display = 'none';
            animate();
        }

        function initThree() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, isMobile ? 80 : 60); // ÊâãÊú∫Á´ØÊãâËøú‰∏ÄÁÇπ

            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            container.appendChild(renderer.domElement);

            // Bloom
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function createParticles() {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(CONFIG.count * 3);
            for(let i=0; i<CONFIG.count*3; i++) pos[i] = (Math.random()-0.5) * 60;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            
            goldMat = new THREE.PointsMaterial({ color: CONFIG.colors.gold, size: isMobile ? 1.0 : 0.8, transparent: true, blending: THREE.AdditiveBlending });
            particleSystem = new THREE.Points(geo, goldMat);
            scene.add(particleSystem);
        }

        async function predictWebcam() {
            if (handLandmarker && videoElement.videoWidth > 0) {
                const results = handLandmarker.detectForVideo(videoElement, performance.now());
                if (results.landmarks.length > 0) {
                    const lm = results.landmarks[0];
                    let fingers = 0;
                    if(lm[8].y < lm[6].y) fingers++;
                    if(lm[12].y < lm[10].y) fingers++;
                    if(lm[16].y < lm[14].y) fingers++;
                    if(lm[20].y < lm[18].y) fingers++;
                    
                    if(fingers >= 4) STATE.mode = 'SCATTER';
                    else if(fingers <= 1) STATE.mode = 'TREE';
                }
            }
            requestAnimationFrame(predictWebcam);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(STATE.mode === 'SCATTER') {
                particleSystem.rotation.y += 0.01;
                particleSystem.scale.setScalar(1.5);
            } else {
                particleSystem.rotation.y += 0.002;
                particleSystem.scale.setScalar(1.0);
            }
            composer.render();
        }
    </script>
</body>
</html>
