<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ğŸ„ æŒ‡å°–é­”æ³• - è¯Šæ–­ç‰ˆ V77</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: monospace; touch-action: none; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        
        #start-btn {
            padding: 15px 40px; font-size: 20px;
            color: #000; background: #00ff00;
            border: none; border-radius: 50px;
            cursor: pointer; margin-bottom: 20px;
            font-weight: bold; box-shadow: 0 0 20px rgba(0,255,0,0.4);
            opacity: 0.5; pointer-events: none; /* é»˜è®¤ç¦ç”¨ï¼ŒåŠ è½½å®Œæ‰å¼€å¯ */
            transition: all 0.3s;
        }
        #start-btn.ready { opacity: 1; pointer-events: auto; }
        
        #console-log {
            width: 90%; height: 200px;
            background: #000; border: 1px solid #333;
            color: #ccc; font-size: 11px;
            padding: 10px; overflow-y: auto;
            border-radius: 4px; text-align: left;
        }
        .log-line { border-bottom: 1px solid #222; padding: 2px 0; }
        .err { color: #ff3333; background: rgba(50,0,0,0.5); }
        .ok { color: #33ff33; }
        .warn { color: #ffff33; }

        #webcam-video { display: none; }
        #ui-layer { position: absolute; bottom: 20px; left: 20px; z-index: 10; display: flex; gap: 15px; }
        .icon-btn { 
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255,255,255,0.2); 
            color: gold; font-size: 24px;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
    </style>

    <script>
        function sysLog(msg, type='info') {
            const box = document.getElementById('console-log');
            if(!box) return;
            const line = document.createElement('div');
            line.className = 'log-line ' + type;
            line.innerText = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}`;
            box.appendChild(line);
            box.scrollTop = box.scrollHeight;
        }
        
        // å…¨å±€é”™è¯¯æ•è· (æ•æ‰è„šæœ¬åŠ è½½å¤±è´¥)
        window.onerror = function(msg, url, line) {
            sysLog(`âŒ è‡´å‘½é”™è¯¯: ${msg} (è¡Œ:${line})`, 'err');
            // å¦‚æœæ˜¯ Script errorï¼Œé€šå¸¸æ˜¯è·¨åŸŸæˆ–ç½‘ç»œé—®é¢˜
            if (msg.toLowerCase().includes('script error')) {
                sysLog("âš ï¸ æç¤º: å¯èƒ½æ˜¯ CDN ç½‘ç»œä¸é€šï¼Œè¯·æ£€æŸ¥ VPN æˆ–ç½‘ç»œã€‚", 'warn');
            }
            return false;
        };

        // ä¾›æ¨¡å—è°ƒç”¨çš„å¯åŠ¨å‡½æ•°å ä½ç¬¦
        window.appReady = false;
        window.doStart = function() {
            sysLog("â³ æ­£åœ¨ç­‰å¾…è„šæœ¬åŠ è½½...", 'warn');
        };
    </script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://esm.sh/three@0.160.0",
                "three/addons/": "https://esm.sh/three@0.160.0/examples/jsm/",
                "@mediapipe/tasks-vision": "https://esm.sh/@mediapipe/tasks-vision@0.10.8"
            }
        }
    </script>
</head>
<body>

    <div id="start-screen">
        <h2 style="color:#fff; margin-bottom:10px;">æŒ‡å°–é­”æ³• V77</h2>
        <button id="start-btn" onclick="window.doStart()">â³ æ­£åœ¨ä¸‹è½½ç»„ä»¶...</button>
        <div id="console-log">
            <div class="log-line">ç³»ç»Ÿåˆå§‹åŒ–...</div>
            <div class="log-line">æ­£åœ¨å°è¯•è¿æ¥ CDN æœåŠ¡å™¨...</div>
        </div>
    </div>

    <div id="canvas-container"></div>
    <video id="webcam-video" playsinline muted autoplay></video>

    <div id="ui-layer">
        <div class="icon-btn" onclick="window.setMode('TREE')">ğŸŒ²</div>
        <div class="icon-btn" onclick="window.setMode('SCATTER')">âœ¨</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // è„šæœ¬åŠ è½½æˆåŠŸï¼Œæ¿€æ´»æŒ‰é’®
        sysLog("âœ… æ ¸å¿ƒåº“ (Three.js/MediaPipe) åŠ è½½æˆåŠŸ!", "ok");
        const startBtn = document.getElementById('start-btn');
        startBtn.innerText = "ğŸš€ ç‚¹å‡»å¯åŠ¨";
        startBtn.classList.add('ready');
        window.appReady = true;

        // === æ ¸å¿ƒé€»è¾‘ ===
        const CONFIG = {
            count: 6000, // æ‰‹æœºç«¯ä¿å‘½è®¾ç½®
            colors: { gold: 0xffd966, green: 0x03180a, red: 0x990000 },
            exp: { tree: 2.0, scatter: 1.2 }
        };

        let scene, camera, renderer, composer;
        let particleSystem, goldMat;
        let handLandmarker, videoElement;
        let STATE = { mode: 'TREE', handX: 0, handY: 0 };

        // çœŸæ­£çš„å¯åŠ¨å‡½æ•°
        window.doStart = async function() {
            if (!window.appReady) return;
            startBtn.style.display = 'none';
            sysLog("ç”¨æˆ·ç‚¹å‡»å¯åŠ¨...");

            try {
                // 1. åˆå§‹åŒ– 3D
                sysLog("åˆå§‹åŒ– 3D åœºæ™¯...");
                initThree();
                createParticles();
                sysLog("3D æ¸²æŸ“å™¨å°±ç»ª", "ok");

                // 2. åŠ è½½ AI
                sysLog("æ­£åœ¨åŠ è½½ AI æ¨¡å‹ (hand_landmarker.task)...");
                sysLog("è¯·ç¡®ä¿ .task æ–‡ä»¶å·²ä¸Šä¼ åˆ° GitHub!");
                
                // å°è¯•åŠ è½½
                const vision = await FilesetResolver.forVisionTasks("https://esm.sh/@mediapipe/tasks-vision@0.10.8/wasm");
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "./hand_landmarker.task", // æœ¬åœ°æ–‡ä»¶
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numHands: 1
                });
                sysLog("AI æ¨¡å‹åŠ è½½æˆåŠŸ!", "ok");

                // 3. æ‘„åƒå¤´
                sysLog("è¯·æ±‚æ‘„åƒå¤´æƒé™...");
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: 320, height: 240 } 
                });
                
                videoElement = document.getElementById('webcam-video');
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    sysLog("æ‘„åƒå¤´ç”»é¢å·²è·å–", "ok");
                    enterScene();
                    predictWebcam();
                };

            } catch (e) {
                sysLog("âŒ å¯åŠ¨é˜»æ–­: " + e.message, "err");
                if(e.message.includes("404") || e.message.includes("fetch")) {
                    sysLog("ğŸ‘‰ æ£€æŸ¥: hand_landmarker.task æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Ÿ", "warn");
                }
                // å¼ºåˆ¶è¿›å…¥æ¼”ç¤ºæ¨¡å¼
                setTimeout(enterScene, 2000);
            }
        };

        function enterScene() {
            document.getElementById('start-screen').style.display = 'none';
            animate();
        }

        // ç®€å•çš„ Three.js åˆå§‹åŒ–
        function initThree() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 60);

            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            container.appendChild(renderer.domElement);

            // Bloom
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function createParticles() {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(CONFIG.count * 3);
            for(let i=0; i<CONFIG.count*3; i++) pos[i] = (Math.random()-0.5) * 60;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            
            goldMat = new THREE.PointsMaterial({ color: CONFIG.colors.gold, size: 0.8, transparent: true, blending: THREE.AdditiveBlending });
            particleSystem = new THREE.Points(geo, goldMat);
            scene.add(particleSystem);
        }

        async function predictWebcam() {
            if (handLandmarker && videoElement.videoWidth > 0) {
                const results = handLandmarker.detectForVideo(videoElement, performance.now());
                if (results.landmarks.length > 0) {
                    const lm = results.landmarks[0];
                    // ç®€å•æ‰‹åŠ¿é€»è¾‘
                    let fingers = 0;
                    if(lm[8].y < lm[6].y) fingers++;
                    if(lm[12].y < lm[10].y) fingers++;
                    if(lm[16].y < lm[14].y) fingers++;
                    if(lm[20].y < lm[18].y) fingers++;
                    
                    if(fingers >= 4) window.setMode('SCATTER');
                    else if(fingers <= 1) window.setMode('TREE');
                }
            }
            requestAnimationFrame(predictWebcam);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(STATE.mode === 'SCATTER') {
                particleSystem.rotation.y += 0.01;
                particleSystem.scale.setScalar(1.5);
            } else {
                particleSystem.rotation.y += 0.002;
                particleSystem.scale.setScalar(1.0);
            }
            composer.render();
        }

        window.setMode = (m) => STATE.mode = m;
    </script>
</body>
</html>
